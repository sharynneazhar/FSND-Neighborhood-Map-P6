"use strict";function loadMapScript(){var a=document.createElement("script");a.async=!0,a.type="text/javascript",a.src=GMAP_FULL_URL,document.body.appendChild(a)}function nonceString(a){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<a;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}var LOCATIONS=[{name:"Town Topic",lat:39.088453,lng:-94.588779,address:["2021 Broadway St","Kansas City, MO 64108"]},{name:"PT's Coffee",lat:39.088554,lng:-94.588155,address:["310 Southwest Blvd","Kansas City, MO 64108"]},{name:"Lulu's Thai Noodle Shop",lat:39.087739,lng:-94.58791,address:["2030 Central St","Kansas City, MO 64108"]},{name:"Mildred's Coffeehouse",lat:39.091076,lng:-94.585831,address:["1821 Wyandotte St","Kansas City, MO 64108"]},{name:"Sylvia's Deli",lat:39.091376,lng:-94.589991,address:["1746 Washington St","Kansas City, MO 64108"]},{name:"Jack Stack BBQ - Freight House",lat:39.087583,lng:-94.585039,address:["101 W 22nd St #300","Kansas City, MO 64108"]},{name:"Coda",lat:39.091239,lng:-94.589067,address:["1744 Broadway St","Kansas City, MO 64108"]},{name:"Extra Virgin",lat:39.090187,lng:-94.58404,address:["1900 Main St","Kansas City, MO 64108"]}],GMAP_KEY="?key=AIzaSyCKioYCg26ODl5A4Z2K03OFkXJRT1mBpRk",GMAP_BASE_URL="http://maps.googleapis.com/maps/",GMAP_FULL_URL=GMAP_BASE_URL+"api/js"+GMAP_KEY+"&libraries=places&callback=LocationService.init",GMAP_QUERY_URL=GMAP_BASE_URL+"api/place/queryautocomplete/json"+GMAP_KEY+"&input=",YELP_BASE_URL="http://api.yelp.com/v2/search/",YELP_CONSUMER_KEY="TvJZDsVoUcBof1g4Vupo0Q",YELP_CONSUMER_SECRET="PEW3KTxsoUUGWROFC0vpzs2O2GM",YELP_TOKEN="eZugQLtOZa7f0ZV2VXRNb76pjTZrUT0T",YELP_TOKEN_SECRET="j-DHHnxNR7bvRpc5K7VqdLqmcDc",DIMS={height:$(window).height(),width:$(window).width()},Splash=window.Splash,map=null,yelpLocations=[],markerArray=[],LocationService={currentLocation:{lat:39.090509,lng:-94.589111},init:function(){Splash.enable("circular");var a=document.getElementById("map"),e={zoom:DIMS.width<662?10:12,center:new google.maps.LatLng(this.currentLocation.lat,this.currentLocation.lng),mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!1,streetViewControl:!1};map=new google.maps.Map(a,e),LocationService.getYelpData(LOCATIONS),setTimeout(function(){LocationService.buildMarkers(yelpLocations),Splash.isRunning&&Splash.destroy()},3e3)},createMarker:function(a,e){var t,n=new google.maps.Marker({title:a.name,position:new google.maps.LatLng(a.lat,a.lng),map:map,animation:google.maps.Animation.DROP});t=""===a.url?'">':(a.url||"#")+'" target="_blank">Visit Website';var o='<div id="venue"><h5 class="venue-name">'+(a.name||"")+'</h5><div class="venue-address">'+(a.address[0]||"")+"<br>"+(a.address[2]||a.address[1]||"")+'</div><div class="venue-contact">'+(a.phone||"")+'</div><div class="venue-url"><a href="'+t+'</a></div><div class="venue-rating" style="margin-top:10px"><img src="'+(a.ratingImage||"")+'" /></div></div>';return google.maps.event.addListener(n,"click",function(){null!==n.getAnimation()?n.setAnimation(null):(n.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){n.setAnimation(null)},750)),e.setContent(o),e.open(map,n)}),n},buildMarkers:function(a){LocationService.clearMarkers();var e=new google.maps.InfoWindow;$.each(a,function(a,t){markerArray.push(LocationService.createMarker(t,e))}),LocationService.displayMarkers()},displayMarkers:function(){var a=new google.maps.LatLngBounds;$.each(markerArray,function(e,t){a.extend(t.getPosition()),t.setMap(map)}),map.fitBounds(a),DIMS.width>662&&map.setZoom(17),Splash.isRunning&&Splash.destroy()},clearMarkers:function(){$.each(markerArray,function(a,e){e.setMap(null)}),markerArray=[]},getYelpData:function(a){yelpLocations=[],$.each(a,function(a,e){var t={oauth_consumer_key:YELP_CONSUMER_KEY,oauth_token:YELP_TOKEN,oauth_nonce:nonceString(15),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",term:e.name,location:"Kansas City, MO",limit:1},n=oauthSignature.generate("GET",YELP_BASE_URL,t,YELP_CONSUMER_SECRET,YELP_TOKEN_SECRET);t.oauth_signature=n,$.ajax({url:YELP_BASE_URL,data:t,cache:!0,dataType:"jsonp",success:function(a){var t=a.businesses[0],n={id:t.id||"",name:t.name||e.name,phone:t.display_phone||"",url:t.url||"",lat:t.location.coordinate.latitude||e.lat,lng:t.location.coordinate.longitude||e.lng,address:t.location.display_address||e.address,ratingImage:t.rating_img_url||""};yelpLocations.push(n)},error:function(a){console.log(a)}})})}};loadMapScript();var Location=function(a){this.id=ko.observable(a.id),this.name=ko.observable(a.name),this.phone=ko.observable(a.phone),this.address=ko.observableArray(a.address),this.lat=ko.observable(a.lat),this.lng=ko.observable(a.lng),this.url=ko.observable(a.url),this.ratingImage=ko.observable(a.ratingImage)},ViewModel=function(){var a=this;a.locationFilter=ko.observable(""),a.locations=ko.observableArray([]),a.filteredLocations=ko.observableArray([]),a.listVisible=ko.observable(!1),setTimeout(function(){$.each(yelpLocations,function(e,t){a.locations.push(new Location(t))})},3500),a.filter=function(){a.filteredLocations([]),Splash.enable("circular");var e=a.locationFilter().toLowerCase();$.each(a.locations(),function(t,n){var o=n.name().toLowerCase();if(o.indexOf(e)>=0){var i={name:n.name(),lat:n.lat(),lng:n.lng()};a.filteredLocations.push(i)}}),a.filteredLocations().length>0?(LocationService.getYelpData(a.filteredLocations()),setTimeout(function(){LocationService.buildMarkers(yelpLocations)},1e3)):alert("No locations found")},a.openInfo=function(){a.toggle(),Splash.enable("circular");var e=[{name:this.name,lat:this.lat,lng:this.lng}];LocationService.getYelpData(e),setTimeout(function(){LocationService.buildMarkers(yelpLocations),Splash.destroy()},1e3)},a.toggle=function(){a.filteredLocations().length<=0&&a.filter(),a.listVisible(!a.listVisible())}};ko.applyBindings(new ViewModel);