"use strict";function nonceString(e){for(var a="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;o<e;o++)a+=n.charAt(Math.floor(Math.random()*n.length));return a}function stopLoading(){Splash.isRunning&&Splash.destroy()}function setMarkers(e){clearMarkers(),$.each(e,function(e,a){createMarker(a)}),map.fitBounds(bounds),DIMS.width>662&&map.setZoom(17)}function clearMarkers(){$.each(markerArray,function(e,a){a.setMap(null)}),markerArray=[]}function createMarker(e){var a=new google.maps.LatLng(e.lat,e.lng),n=new google.maps.Marker({title:e.name,position:a,map:map,animation:google.maps.Animation.DROP});bounds.extend(n.position);var o;o=""===e.url?'">':(e.url||"#")+'" target="_blank">Visit Website';var t='<div id="venue"><h5 class="venue-name">'+(e.name||"")+'</h5><div class="venue-address">'+(e.address[0]||"")+"<br>"+(e.address[2]||e.address[1]||"")+'</div><div class="venue-contact">'+(e.phone||"")+'</div><div class="venue-url"><a href="'+o+'</a></div><div class="venue-rating" style="margin-top:10px"><img src="'+(e.ratingImage||"")+'" /></div></div>';google.maps.event.addListener(n,"click",function(){null!==n.getAnimation()?n.setAnimation(null):(n.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){n.setAnimation(null)},1400)),infoWindow.setContent(t),infoWindow.open(map,n),map.setCenter(n.getPosition())}),e.marker=n,markerArray.push(n)}function getYelpData(e){$.each(e,function(e,a){var n={oauth_consumer_key:YELP_CONSUMER_KEY,oauth_token:YELP_TOKEN,oauth_nonce:nonceString(15),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",term:a.name,location:"Kansas City, MO",limit:1};n.oauth_signature=oauthSignature.generate("GET",YELP_BASE_URL,n,YELP_CONSUMER_SECRET,YELP_TOKEN_SECRET),$.ajax({url:YELP_BASE_URL,data:n,cache:!0,async:!0,dataType:"jsonp"}).done(function(e){var n=e.businesses[0],o={id:n.id||"",name:n.name||a.name,phone:n.display_phone||"",url:n.url||"",lat:n.location.coordinate.latitude||a.lat,lng:n.location.coordinate.longitude||a.lng,address:n.location.display_address||a.address,ratingImage:n.rating_img_url||""};yelpLocations.push(o),8===yelpLocations.length&&(setMarkers(yelpLocations),vm.locations(yelpLocations),stopLoading())}).fail(function(){errorHandler("Faild to load data from Yelp. Try again later.")})})}function initializeMap(){Splash.enable("circular");var e=document.getElementById("map"),a={zoom:DIMS.width<662?10:16,center:new google.maps.LatLng(CURRENT_LOCATION.lat,CURRENT_LOCATION.lng),mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!1,streetViewControl:!1};infoWindow=new google.maps.InfoWindow,bounds=new google.maps.LatLngBounds,map=new google.maps.Map(e,a),getYelpData(LOCATIONS),ko.applyBindings(vm)}function errorHandler(e){e?$(".error-msg").html(e):$(".error-msg").html("The page didn't load Google Maps correctly. Try refreshing the page or try again later."),$("#mapErrorModal").modal("show")}var Splash=window.Splash,DIMS={height:$(window).height(),width:$(window).width()},LOCATIONS=[{name:"Town Topic",lat:39.088453,lng:-94.588779,address:["2021 Broadway St","Kansas City, MO 64108"]},{name:"PT's Coffee",lat:39.088554,lng:-94.588155,address:["310 Southwest Blvd","Kansas City, MO 64108"]},{name:"Lulu's Thai Noodle Shop",lat:39.087739,lng:-94.58791,address:["2030 Central St","Kansas City, MO 64108"]},{name:"Mildred's Coffeehouse",lat:39.091076,lng:-94.585831,address:["1821 Wyandotte St","Kansas City, MO 64108"]},{name:"Sylvia's Deli",lat:39.091376,lng:-94.589991,address:["1746 Washington St","Kansas City, MO 64108"]},{name:"Jack Stack BBQ - Freight House",lat:39.087583,lng:-94.585039,address:["101 W 22nd St #300","Kansas City, MO 64108"]},{name:"Coda",lat:39.091239,lng:-94.589067,address:["1744 Broadway St","Kansas City, MO 64108"]},{name:"Extra Virgin",lat:39.090187,lng:-94.58404,address:["1900 Main St","Kansas City, MO 64108"]}],GMAP_KEY="AIzaSyCKioYCg26ODl5A4Z2K03OFkXJRT1mBpRk",GMAP_BASE_URL="http://maps.googleapis.com/maps/",YELP_BASE_URL="http://api.yelp.com/v2/search/",YELP_CONSUMER_KEY="TvJZDsVoUcBof1g4Vupo0Q",YELP_CONSUMER_SECRET="PEW3KTxsoUUGWROFC0vpzs2O2GM",YELP_TOKEN="eZugQLtOZa7f0ZV2VXRNb76pjTZrUT0T",YELP_TOKEN_SECRET="j-DHHnxNR7bvRpc5K7VqdLqmcDc",CURRENT_LOCATION={lat:39.090509,lng:-94.589111},yelpLocations=[],markerArray=[],infoWindow,bounds,map=null,ViewModel=function(){var e=this;e.locationFilter=ko.observable(),e.locations=ko.observableArray([]),e.filteredLocations=ko.observableArray([]),e.filteredVisible=ko.observable(!1),e.menuVisible=ko.observable(!1),e.filter=function(){Splash.enable("circular"),e.filteredLocations([]);var a=e.locationFilter().toLowerCase();$.each(e.locations(),function(n,o){var t=o.name.toLowerCase();""===a?o.marker.setVisible(!0):t.indexOf(a)>=0?(e.toggle(),e.filteredLocations.push(o)):o.marker.setVisible(!1),stopLoading()})},e.openInfo=function(){e.toggle(),Splash.enable("circular"),google.maps.event.trigger(this.marker,"click"),stopLoading()},e.toggle=function(){e.menuVisible()&&e.toggleMenu(),e.filteredVisible(!e.filteredVisible())},e.toggleMenu=function(){e.filteredVisible()&&e.toggle(),e.menuVisible(!e.menuVisible())}},vm=new ViewModel;